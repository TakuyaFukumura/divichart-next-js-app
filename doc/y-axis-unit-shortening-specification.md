# グラフy軸単位短縮表示機能 仕様書

## 1. ドキュメント情報

- **作成日**: 2026年2月7日
- **ドキュメント種別**: 機能仕様書
- **対象機能**: グラフy軸の数値表示単位の短縮化
- **対象読者**: 開発者、レビュアー、プロジェクト関係者
- **関連ドキュメント**: 
  - [developer-specification.md](./developer-specification.md)

---

## 2. 概要

### 2.1 目的

グラフのy軸に表示される金額の表示形式を短縮することで、特にスマートフォンなどの小さな画面でのユーザビリティを向上させる。現在、「320000」のような長い数値表示が画面スペースを圧迫し、見づらくなっている問題を解決する。

### 2.2 背景

- 現在のグラフy軸では、「320000」のような長い数値がそのまま表示されている
- スマートフォンの小さな画面では、長い数値表示がy軸領域を圧迫し、グラフ全体の視認性が低下している
- 日本語の数値単位（万、千）を活用することで、より短く直感的な表示が可能
- 累計配当グラフページ（`/cumulative`）では既に簡易的な「K」表示（例: ¥32K）が実装されているが、日本語表記の方がより自然で理解しやすい

### 2.3 対象範囲

- **対象ページ**: 
  - 年別配当グラフページ（`/` - ホームページ）
  - 累計配当グラフページ（`/cumulative`）
  - その他、将来追加される可能性のある金額グラフ
- **対象要素**: Rechartsライブラリで描画される各種グラフのY軸（YAxis）
- **対象データ**: 配当金額の数値データ（円単位）

---

## 3. 現状分析

### 3.1 現在の表示方式

#### 年別配当グラフページ（`/page.tsx`）

```tsx
<YAxis/>
```

- **表示例**: 0, 100000, 200000, 300000, 400000
- **問題点**:
  - 数値が長く、y軸の幅を取る
  - 桁数が多く瞬時に金額を把握しづらい
  - スマートフォン表示で特に見づらい

#### 累計配当グラフページ（`/cumulative/page.tsx`）

```tsx
<YAxis
    tick={{fill: '#6b7280'}}
    className="dark:fill-gray-400"
    tickFormatter={(value: number) =>
        value < 1000
            ? `¥${value.toLocaleString()}`
            : `¥${(value / 1000).toFixed(0)}K`
    }
/>
```

- **表示例**: ¥0, ¥100K, ¥200K, ¥300K, ¥400K
- **問題点**:
  - 「K」（千の単位）は英語圏の表記で、日本のユーザーには馴染みが薄い
  - より自然な日本語表記（万円）の方が直感的

### 3.2 想定される金額の範囲

配当金額のデータを分析すると、以下の範囲が想定されます：

1. **年別配当金**: 数万円〜数百万円
   - 例: 50,000円、320,000円、1,500,000円

2. **累計配当金**: 数十万円〜数千万円
   - 例: 500,000円、3,200,000円、15,000,000円

3. **極端なケース**:
   - 最小値: 1,000円未満（初年度など）
   - 最大値: 1億円以上（長期投資家の累計配当）

---

## 4. 要件定義

### 4.1 機能要件

#### FR-1: 日本語単位表示の実装

- **要件**: y軸の数値を日本語の単位（万、千）を使って短縮表示する（千円単位での短縮表示も含め、常に有効とする）
- **優先度**: 必須
- **詳細**:
  - 10,000円以上の金額は「万円」単位で表示
  - 1,000円以上10,000円未満の金額は「千円」単位で表示（常に短縮表示を行う）
  - 1,000円未満の金額はそのまま「円」で表示

#### FR-2: 表示精度の適切な設定

- **要件**: 金額の精度を適切に保ちながら短縮表示する
- **優先度**: 必須
- **詳細**:
  - 万円表示時の小数点桁数を適切に設定（0〜1桁を推奨）
  - FR-1 で定義した固定閾値（1,000円／10,000円）に基づいて表示単位と小数点桁数を選択する

#### FR-3: 共通化されたフォーマット関数の作成

- **要件**: y軸フォーマット処理を再利用可能な関数として実装する
- **優先度**: 必須
- **詳細**:
  - 複数のページ・コンポーネントで同じフォーマット処理を使用できるようにする
  - ユーティリティ関数として `src/lib/` または `src/utils/` に配置

#### FR-4: y軸の通貨記号表記

- **要件**: y軸では通貨記号（¥）を使用せず、日本語単位のみで表示する
- **優先度**: 必須
- **詳細**:
  - y軸は「円」「千円」「万円」の表記のみ（例: 32万円）
  - 通貨記号（¥）は付けない（簡潔さを優先）
  - ツールチップでは従来通り通貨記号付きの詳細表示を維持（例: ¥320,000）

#### FR-5: 既存のツールチップ表示は維持

- **要件**: マウスホバー時のツールチップでは詳細な金額を表示し続ける
- **優先度**: 必須
- **詳細**:
  - y軸は短縮表示（例: 32万円）、ツールチップは完全な金額（例: ¥320,000）
  - ユーザーが正確な金額を確認できる手段を維持

#### FR-6: ダークモード対応

- **要件**: ダークモード時にも適切な色で表示される
- **優先度**: 必須
- **詳細**:
  - 既存のダークモード対応を維持
  - y軸のテキスト色が背景色に対して適切なコントラストを持つ

### 4.2 非機能要件

#### NFR-1: パフォーマンス

- **要件**: フォーマット処理がグラフ描画のパフォーマンスに悪影響を与えない
- **詳細**:
  - tickFormatterは頻繁に呼び出されるため、軽量な実装とする
  - 不要な計算やメモリアロケーションを避ける

#### NFR-2: 保守性

- **要件**: コードが理解しやすく、将来の変更に柔軟に対応できる
- **詳細**:
  - フォーマットロジックを関数として分離
  - JSDocコメントで処理内容を明確に記述
  - テストコードを追加して動作を保証

#### NFR-3: 一貫性

- **要件**: アプリケーション全体で統一されたフォーマット規則を使用する
- **詳細**:
  - すべてのグラフで同じフォーマット関数を使用
  - 表示ルールを一元管理

---

## 5. 設計

### 5.1 表示フォーマット仕様

#### 基本ルール

金額の大きさに応じて以下のように表示する：

**重要**: y軸では通貨記号（¥）を使用せず、日本語単位（円、千円、万円）のみで表示します。これにより、より簡潔で視認性の高い表示を実現します。

| 金額の範囲 | 表示形式 | 例（入力） | 例（出力） |
|---------|---------|---------|---------|
| 0円 | 0 | 0 | 0 |
| 1円〜999円 | N円 | 500 | 500円 |
| 1,000円〜9,999円 | N千円 | 5,000 | 5千円 |
| 10,000円〜999,999円 | N万円 | 50,000 | 5万円 |
| 1,000,000円〜9,999,999円 | NNN万円 | 3,200,000 | 320万円 |
| 10,000,000円以上 | NNNN万円 | 15,000,000 | 1500万円 |

#### オプションA: シンプル版（推奨）

- 10,000円以上: 万円単位（小数点なし）
- 1,000円以上10,000円未満: 千円単位（小数点なし）
- 1,000円未満: 円単位

```typescript
// 例: 320,000 → "32万円"
// 例: 5,000 → "5千円"
// 例: 500 → "500円"
```

### 5.2 実装アプローチ

#### 5.2.1 ユーティリティ関数の作成

新しいファイル `src/lib/formatYAxisValue.ts` を作成：

```typescript
/**
 * グラフのy軸用に金額を短縮表示する
 * 
 * @param value - 表示する金額（円単位）
 * @returns 短縮表示された文字列
 * 
 * @example
 * formatYAxisValue(0) // "0"
 * formatYAxisValue(500) // "500円"
 * formatYAxisValue(5000) // "5千円"
 * formatYAxisValue(50000) // "5万円"
 * formatYAxisValue(320000) // "32万円"
 * formatYAxisValue(3200000) // "320万円"
 */
export function formatYAxisValue(value: number): string {
    if (value === 0) {
        return '0';
    }

    const sign = value < 0 ? '-' : '';
    const absValue = Math.abs(value);

    // 1万円以上の場合は万円単位で表示（小数点なし）
    if (absValue >= 10000) {
        const manValue = Math.floor(absValue / 10000);
        return `${sign}${manValue}万円`;
    }

    // 1千円以上1万円未満の場合は千円単位で表示（小数点なし）
    if (absValue >= 1000) {
        const senValue = Math.floor(absValue / 1000);
        return `${sign}${senValue}千円`;
    }

    // 1千円未満の場合は円単位で表示
    return `${sign}${absValue}円`;
}
```

#### 5.2.2 各ページでの適用

**年別配当グラフページ（`src/app/page.tsx`）**

```tsx
import {formatYAxisValue} from '@/lib/formatYAxisValue';

// YAxisコンポーネントを更新
<YAxis
    tickFormatter={formatYAxisValue}
/>
```

**累計配当グラフページ（`src/app/cumulative/page.tsx`）**

```tsx
import {formatYAxisValue} from '@/lib/formatYAxisValue';

// YAxisコンポーネントを更新（既存のtickFormatterを置き換え）
<YAxis
    tick={{fill: '#6b7280'}}
    className="dark:fill-gray-400"
    tickFormatter={formatYAxisValue}
/>
```

---

## 6. UI/UX設計

### 6.1 表示例（Before / After）

#### 年別配当グラフページ

**Before（現在）**:
```
Y軸表示:
400000 ─
300000 ─
200000 ─
100000 ─
0      ─
```

**After（改善後）**:
```
Y軸表示:
40万円 ─
30万円 ─
20万円 ─
10万円 ─
0     ─
```

#### 累計配当グラフページ

**Before（現在）**:
```
Y軸表示:
¥400K ─
¥300K ─
¥200K ─
¥100K ─
¥0    ─
```

**After（改善後）**:
```
Y軸表示:
40万円 ─
30万円 ─
20万円 ─
10万円 ─
0     ─
```

### 6.2 レスポンシブ対応

- **スマートフォン（〜640px）**:
  - 短縮表示により、y軸の幅が削減され、グラフ領域が広がる
  - テキストサイズは既存のResponsiveContainer設定に依存

- **タブレット（641px〜1024px）**:
  - デスクトップと同様の表示

- **デスクトップ（1025px〜）**:
  - 十分な画面幅があるため、短縮表示により視認性が向上

### 6.3 アクセシビリティ

- **スクリーンリーダー対応**:
  - 数値はそのままスクリーンリーダーで読み上げられる
  - 「万円」「千円」などの単位も明確に読み上げられる

- **色覚多様性対応**:
  - テキストの色はダークモード/ライトモードで適切なコントラストを維持
  - 既存のTailwind CSS設定を継承

---

## 7. テスト仕様

### 7.1 ユニットテスト

#### テスト対象: `formatYAxisValue`関数

| テストケース | 入力値 | 期待される出力 | 説明 |
|---------|-------|--------------|------|
| ゼロ値 | 0 | "0" | ゼロは特別な表示 |
| 小額（円単位） | 500 | "500円" | 1千円未満 |
| 境界値（千円） | 1000 | "1千円" | 1千円ちょうど |
| 中額（千円単位） | 5000 | "5千円" | 1万円未満 |
| 小数切り捨て（千円） | 5500 | "5千円" | 5.5千円→5千円に切り捨て |
| 境界値（万円） | 10000 | "1万円" | 1万円ちょうど |
| 中額（万円単位） | 50000 | "5万円" | 数万円 |
| 小数切り捨て（万円） | 55000 | "5万円" | 5.5万円→5万円に切り捨て |
| 大額（万円単位） | 320000 | "32万円" | 数十万円 |
| 超大額（万円単位） | 3200000 | "320万円" | 数百万円 |
| 超大額（万円単位） | 15000000 | "1500万円" | 千万円台 |
| 負の値（千円） | -5000 | "-5千円" | 負の値の処理 |
| 負の値（万円） | -50000 | "-5万円" | 負の値の処理 |

テストファイル: `__tests__/src/lib/formatYAxisValue.test.ts`

```typescript
import {formatYAxisValue} from '@/lib/formatYAxisValue';

describe('formatYAxisValue', () => {
    it('should return "0" for zero', () => {
        expect(formatYAxisValue(0)).toBe('0');
    });

    it('should format values less than 1000 as "N円"', () => {
        expect(formatYAxisValue(500)).toBe('500円');
    });

    it('should format values from 1000 to 9999 as "N千円" (no decimal)', () => {
        expect(formatYAxisValue(1000)).toBe('1千円');
        expect(formatYAxisValue(5000)).toBe('5千円');
        expect(formatYAxisValue(5500)).toBe('5千円'); // 小数点なし、切り捨て
    });

    it('should format values 10000 and above as "N万円" (no decimal)', () => {
        expect(formatYAxisValue(10000)).toBe('1万円');
        expect(formatYAxisValue(50000)).toBe('5万円');
        expect(formatYAxisValue(55000)).toBe('5万円'); // 小数点なし、切り捨て
        expect(formatYAxisValue(320000)).toBe('32万円');
        expect(formatYAxisValue(3200000)).toBe('320万円');
        expect(formatYAxisValue(15000000)).toBe('1500万円');
    });

    it('should handle negative values', () => {
        expect(formatYAxisValue(-5000)).toBe('-5千円');
        expect(formatYAxisValue(-50000)).toBe('-5万円');
    });
});
```

### 7.2 結合テスト

#### テスト対象: グラフコンポーネント

- **テストケース1**: 年別配当グラフページでy軸が短縮表示される
  - データを読み込み、グラフが描画される
  - y軸のラベルが「32万円」形式で表示される

- **テストケース2**: 累計配当グラフページでy軸が短縮表示される
  - データを読み込み、グラフが描画される
  - y軸のラベルが「32万円」形式で表示される

- **テストケース3**: ツールチップは完全な金額を表示
  - グラフ上でマウスホバーする
  - ツールチップに「¥320,000」のような完全な金額が表示される

### 7.3 手動テスト

#### 視覚的確認

1. **デスクトップブラウザ**:
   - Chrome、Firefox、Safari、Edgeで表示確認
   - ライトモード/ダークモードの切り替え確認

2. **モバイルブラウザ**:
   - iOS Safari、Android Chromeで表示確認
   - 画面サイズに応じた表示の適切性確認

3. **レスポンシブデザイン**:
   - DevToolsを使用して各種画面サイズでの表示確認
   - y軸の短縮表示によりグラフ領域が適切に広がっているか確認

---

## 8. 実装計画

### 8.1 実装タスク

| タスクID | タスク名 | 説明 | 見積もり |
|---------|---------|------|---------|
| TASK-01 | ユーティリティ関数の作成 | `formatYAxisValue`関数を実装 | 1h |
| TASK-02 | ユニットテストの作成 | `formatYAxisValue`関数のテストコードを実装 | 1h |
| TASK-03 | 年別配当グラフページの更新 | `page.tsx`のYAxisに`tickFormatter`を適用 | 0.5h |
| TASK-04 | 累計配当グラフページの更新 | `cumulative/page.tsx`のYAxisの`tickFormatter`を更新 | 0.5h |
| TASK-05 | 結合テストの更新 | グラフコンポーネントのテストを更新 | 1h |
| TASK-06 | 手動テスト・動作確認 | 各ブラウザ、デバイスでの表示確認 | 1h |
| TASK-07 | コードレビュー・修正 | レビューコメントへの対応 | 1h |

**合計見積もり**: 約6時間

### 8.2 実装順序

1. **フェーズ1: 基礎実装**（TASK-01〜02）
   - ユーティリティ関数とテストの作成
   - ローカル環境での動作確認

2. **フェーズ2: 画面への適用**（TASK-03〜04）
   - 各ページのYAxisコンポーネント更新
   - ローカル環境での視覚的確認

3. **フェーズ3: テスト・品質保証**（TASK-05〜06）
   - テストコードの更新と実行
   - 各種ブラウザ・デバイスでの確認

4. **フェーズ4: レビュー・リリース**（TASK-07）
   - プルリクエスト作成
   - コードレビュー対応
   - マージ・デプロイ

### 8.3 リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| 既存のグラフレイアウトが崩れる | 中 | 低 | 各画面で視覚的確認を徹底 |
| パフォーマンスへの影響 | 低 | 低 | 軽量な関数実装、必要に応じてメモ化 |
| 異なるブラウザでの表示差異 | 低 | 低 | 主要ブラウザでの動作確認 |
| ユーザーからの混乱（表示形式の変更） | 低 | 低 | 直感的な日本語表記のため問題なしと想定 |

---

## 9. 補足事項

### 9.1 将来の拡張性

#### 億円単位への対応

**注**: 以下の拡張は現在のFR-4（y軸は「円/千円/万円」のみ）の適用範囲外です。将来的に億円単位の対応が必要になった場合は、FR-4の要件を更新した上で実装を行います。

現在の配当データでは億円単位は想定されないが、将来的に対応が必要な場合は以下のように拡張可能：

```typescript
// 1億円以上の場合は億円単位で表示（将来の拡張）
if (value >= 100000000) {
    const okuValue = Math.floor(value / 100000000);
    return `${okuValue}億円`;
}
```

#### 国際化対応（i18n）

将来的に英語などの他言語対応が必要な場合は、以下のように拡張可能：

```typescript
export function formatYAxisValue(value: number, locale: string = 'ja'): string {
    if (locale === 'en') {
        // 英語の場合は K, M 表記（通貨記号は付与しない。通貨・記号は別要件で扱う）
        if (value >= 1000000) {
            return `${(value / 1000000).toFixed(1)}M`;
        }
        if (value >= 1000) {
            return `${(value / 1000).toFixed(0)}K`;
        }
        return `${value}`;
    }
    
    // 日本語の場合（現在の実装）
    // ...
}
```

### 9.2 参考情報

#### Rechartsのドキュメント

- [YAxis tickFormatter](https://recharts.org/en-US/api/YAxis#tickFormatter)
- YAxisコンポーネントの`tickFormatter`プロパティは、y軸のラベルをカスタマイズするための関数を受け取る
- 関数のシグネチャ: `(value: number) => string`

#### 日本の数値表記

- **千（せん）**: 1,000 = 10³
- **万（まん）**: 10,000 = 10⁴
- **億（おく）**: 100,000,000 = 10⁸

日本では4桁ごとに単位が変わるため、英語圏の3桁区切り（thousand, million）とは異なる。

---

## 10. まとめ

本仕様書では、グラフのy軸に表示される金額を日本語の単位（万円、千円）を使って短縮表示する機能を定義しました。

### 主要な決定事項

1. **フォーマット関数**: `formatYAxisValue`を新規作成し、共通化する
2. **表示ルール**: 
   - 1万円以上: 万円単位（小数点なし／0桁、小数部は切り捨て）
   - 1千円〜1万円未満: 千円単位（千円短縮は常に有効／必須）
   - 1千円未満: 円単位
3. **適用範囲**: 年別配当グラフページ、累計配当グラフページの両方
4. **既存機能**: ツールチップの詳細表示は維持

### 期待される効果

- **視認性の向上**: 特にスマートフォンでのグラフ表示が改善される
- **理解しやすさ**: 日本語の単位により、瞬時に金額を把握できる
- **一貫性**: 全グラフで統一されたフォーマットが使用される

### 次のステップ

1. 本仕様書のレビューと承認
2. 実装タスクの開始
3. テスト実施と品質確認
4. プルリクエスト作成とマージ

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|---------|---------|-------|
| 2026-02-07 | 1.0 | 初版作成 | - |
