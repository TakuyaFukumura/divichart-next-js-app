# 為替レート設定共通化仕様検討書

## 概要

本ドキュメントは、divichart-next-js-appアプリケーションにおける為替レート設定を共通化し、1箇所で管理できるようにするための仕様検討を行ったものです。

## 現状分析

### 現在の実装方法

現在、為替レート（USD→JPY）は以下の3つのページで個別に管理されています：

1. **ホームページ** (`src/app/page.tsx`)
2. **累計配当グラフページ** (`src/app/cumulative/page.tsx`)
3. **配当ポートフォリオページ** (`src/app/portfolio/page.tsx`)

#### 各ページの実装詳細

```typescript
// 各ページで共通のパターン
const DEFAULT_USD_TO_JPY_RATE = 150;
const envRate = process.env.NEXT_PUBLIC_USD_TO_JPY_RATE
    ? Number(process.env.NEXT_PUBLIC_USD_TO_JPY_RATE)
    : NaN;
const USD_TO_JPY_RATE = !isNaN(envRate) && envRate > 0 ? envRate : DEFAULT_USD_TO_JPY_RATE;

// コンポーネント内で使用
const [usdToJpyRate, setUsdToJpyRate] = useState<number>(USD_TO_JPY_RATE);
const [inputValue, setInputValue] = useState<string>(String(USD_TO_JPY_RATE));
```

### 現状の問題点

1. **コードの重複**
   - 同じ為替レート取得ロジックが3つのファイルに重複している
   - デフォルト値が各ファイルで定義されており、変更時に3箇所修正が必要

2. **設定の一貫性の欠如**
   - 各ページで独立して為替レートを管理しているため、ページ間で異なる為替レートが設定される可能性がある
   - ユーザーが各ページで個別に為替レートを入力する必要がある

3. **ユーザビリティの問題**
   - ページを移動するたびに為替レート設定がリセットされる可能性がある
   - アプリケーション全体で統一した為替レートを使用したい場合、各ページで設定が必要

4. **保守性の問題**
   - デフォルト値の変更や為替レート取得ロジックの変更時に複数箇所を修正する必要がある

## 共通化の目的

1. **コードの一元管理**
   - 為替レート設定ロジックを1箇所に集約し、保守性を向上させる

2. **ユーザー体験の向上**
   - 一度設定した為替レートがアプリケーション全体で共有される
   - ページ遷移時も設定が保持される

3. **設定の可視性向上**
   - 専用の設定画面で為替レートを管理できるようにする
   - 現在の設定値が明確に確認できる

## 提案する実装方式

### 1. Context APIを使用した状態管理

#### メリット
- Reactの標準機能で実装可能（追加ライブラリ不要）
- コンポーネント階層全体で状態を共有できる
- 既存のDarkModeProviderと同様のパターンで実装可能

#### デメリット
- ページをリロードすると設定がリセットされる（localStorageとの組み合わせで解決可能）

### 2. 実装する機能

#### 2.1 ExchangeRateProvider（Context Provider）

**配置場所**: `src/app/contexts/ExchangeRateContext.tsx`

**機能**:
- 為替レート状態の管理
- localStorage への永続化
- デフォルト値の設定

**提供する値**:
```typescript
interface ExchangeRateContextValue {
  usdToJpyRate: number;           // 現在の為替レート
  setUsdToJpyRate: (rate: number) => void;  // 為替レート更新関数
  defaultRate: number;            // デフォルト値（定数）
  resetToDefault: () => void;     // デフォルト値にリセット
}
```

#### 2.2 設定画面

**配置場所**: `src/app/settings/page.tsx`

**機能**:
- 為替レートの表示と編集
- デフォルト値へのリセット機能
- 入力値のバリデーション（正の数値のみ）
- 設定の保存（localStorageに自動保存）

**UI要素**:
- 為替レート入力フィールド（数値入力）
- デフォルト値の表示
- リセットボタン
- 現在の設定値の説明

#### 2.3 ヘッダーへのリンク追加

**変更箇所**: `src/app/components/Header.tsx`

**機能**:
- 設定画面へのナビゲーションリンク追加
- 設定アイコン（⚙️）の表示

### 3. データフロー

```
┌─────────────────────────────────────────────────┐
│           ExchangeRateProvider                   │
│  (Context + localStorage)                        │
│                                                   │
│  ・デフォルト値: 150円                            │
│  ・環境変数: NEXT_PUBLIC_USD_TO_JPY_RATE         │
│  ・ユーザー設定: localStorage保存                 │
└─────────────┬───────────────────────────────────┘
              │
              ├──────────────┬──────────────┬────────────────┐
              │              │              │                │
              ▼              ▼              ▼                ▼
         ┌─────────┐  ┌─────────┐  ┌─────────┐      ┌─────────┐
         │  Home   │  │Cumulative│  │Portfolio│      │Settings │
         │  Page   │  │   Page   │  │  Page   │      │  Page   │
         └─────────┘  └─────────┘  └─────────┘      └─────────┘
```

### 4. 為替レートの優先順位

以下の順序で為替レートを決定します：

1. **ユーザー設定値**（localStorage）
   - 設定画面で変更された値
   - 最優先で使用される

2. **環境変数**（`NEXT_PUBLIC_USD_TO_JPY_RATE`）
   - `.env.local`ファイルで設定可能
   - ユーザー設定がない場合に使用

3. **デフォルト値**（150円）
   - コード内の定数として定義
   - 環境変数も設定されていない場合に使用

### 5. 各ページからの為替レート入力フィールドの扱い

#### 選択肢A: 完全に削除する（推奨）

**メリット**:
- UIがシンプルになる
- 設定の一元管理が徹底される
- ユーザーの混乱を防げる

**デメリット**:
- 一時的な為替レート変更ができなくなる

#### 選択肢B: 読み取り専用フィールドとして残す

**メリット**:
- 現在使用している為替レートが各ページで確認できる
- 設定画面へのリンクを配置して誘導できる

**デメリット**:
- UIが煩雑になる可能性がある

#### 選択肢C: 完全に非表示にする

**メリット**:
- 最もシンプルな実装
- ページ本来の情報に集中できる

**デメリット**:
- 使用している為替レートが分かりにくい

**推奨**: 選択肢Aを採用し、各ページのフッター部分に「※ USドル建ての配当金は1ドル=XXX円で換算しています。」という表示は残す。

### 6. 実装の段階的なアプローチ

#### Phase 1: Context の実装
1. `ExchangeRateContext.tsx` の作成
2. `layout.tsx` でProviderを適用
3. 既存ページの動作確認

#### Phase 2: 設定画面の追加
1. `settings/page.tsx` の作成
2. Headerにリンク追加
3. 設定画面のテスト

#### Phase 3: 既存ページの更新
1. 各ページで Context を使用するように変更
2. 入力フィールドの削除
3. 動作確認とテスト

#### Phase 4: ドキュメントと最終調整
1. READMEの更新
2. コード内コメントの追加
3. テストコードの追加

## デフォルト値の扱い

### 現在のデフォルト値

- **値**: 150円（1ドル = 150円）
- **定義場所**: 各ページファイルの定数として定義

### 共通化後のデフォルト値

- **値**: 150円（変更なし）
- **定義場所**: `src/app/contexts/ExchangeRateContext.tsx`
- **上書き方法**:
  1. 環境変数 `NEXT_PUBLIC_USD_TO_JPY_RATE` で設定
  2. 設定画面からユーザーが変更

## 技術的考慮事項

### 1. localStorage の使用

```typescript
// 保存
localStorage.setItem('usdToJpyRate', String(rate));

// 読み込み
const savedRate = localStorage.getItem('usdToJpyRate');
const rate = savedRate ? parseFloat(savedRate) : null;
```

### 2. 環境変数の扱い

Next.js の環境変数は **単一の優先順位で一括して読み込まれるのではなく**、`NODE_ENV` に応じて読み込まれるファイルが異なります。
代表的な例は以下のとおりです（詳細は公式ドキュメントを参照してください）：

- 開発環境 (`NODE_ENV=development`)
  - `.env.development.local`（最優先、通常は gitignore 対象）
  - `.env.development`
  - `.env.local`
  - `.env`（全環境共通のデフォルト値）
- 本番環境 (`NODE_ENV=production`)
  - `.env.production.local`（最優先、通常は gitignore 対象）
  - `.env.production`
  - `.env.local`
  - `.env`（全環境共通のデフォルト値）

なお、実際にどのファイルがどの順序で読み込まれるかは Next.js のバージョンや設定に依存するため、最新かつ正確な仕様は公式ドキュメントを参照してください：
https://nextjs.org/docs/app/building-your-application/configuring/environment-variables
### 3. 型安全性

```typescript
// 為替レートの型定義
type ExchangeRate = number; // 正の数値のみ

// バリデーション関数
function isValidExchangeRate(value: number): boolean {
  return !isNaN(value) && value > 0 && isFinite(value);
}
```

### 4. パフォーマンス考慮事項

- Context の更新頻度は低い（ユーザーが明示的に変更した時のみ）
- localStorage へのアクセスは同期処理だが、頻度が低いため問題なし
- 不要な再レンダリングを防ぐため、useMemo/useCallback を適切に使用

## UI/UXの考慮事項

### 設定画面のデザイン

1. **明確なラベル**: 「為替レート（1ドル = 円）」
2. **現在の値の表示**: 大きく見やすい表示
3. **デフォルト値の表示**: 「デフォルト: 150円」と明示
4. **バリデーションメッセージ**: 無効な入力時にエラー表示
5. **即時反映**: 入力後すぐに全ページに反映
6. **リセットボタン**: デフォルト値に簡単に戻せる

### アクセシビリティ

- キーボード操作対応
- スクリーンリーダー対応
- 適切なARIAラベルの設定
- フォーカス管理

## テスト戦略

### 単体テスト

1. **ExchangeRateContext のテスト**
   - デフォルト値の確認
   - 値の更新
   - localStorage への保存/読み込み
   - リセット機能

2. **設定画面のテスト**
   - 入力値のバリデーション
   - 保存機能
   - リセット機能

### 統合テスト

1. **ページ間の状態共有**
   - 設定変更が全ページに反映されることを確認
   - ページ遷移時の状態保持を確認

2. **永続化のテスト**
   - ページリロード後も設定が保持されることを確認

## マイグレーション計画

### 既存ユーザーへの影響

1. **環境変数を設定していないユーザー**
   - 影響なし（デフォルト値150円を継続使用）

2. **環境変数を設定しているユーザー**
   - 設定値が引き続き使用される
   - 必要に応じて設定画面から変更可能

### データ移行

- 為替レート設定は新規に `usdToJpyRate` という localStorage キーで保存する
- 現行コードでは為替レートを localStorage に保存していないため、既存キーからの移行は不要

## リスクと対策

### リスク1: localStorage が使用できない環境

**対策**: fallback として sessionStorage を使用、それも使えない場合はメモリ上の状態のみ使用

### リスク2: 既存機能への影響

**対策**: 段階的な実装とテストを徹底。各Phase で動作確認を行う

### リスク3: パフォーマンスへの影響

**対策**: Context の更新頻度は低いため、実質的な影響はほぼなし

## 今後の拡張性

### 将来的に追加可能な機能

1. **複数通貨対応**
   - EUR, GBP など他の通貨の為替レートも設定可能に

2. **為替レート履歴**
   - 過去の為替レート設定を記録・表示

3. **自動更新機能**
   - APIから最新の為替レートを取得して自動更新

4. **為替レートプリセット**
   - よく使う為替レートをプリセットとして保存

## まとめ

本仕様書では、為替レート設定を共通化し、Context APIとlocalStorageを組み合わせた実装方式を提案しました。この方式により、以下のメリットが得られます：

1. **コードの保守性向上**: 為替レート管理ロジックの一元化
2. **ユーザー体験の向上**: ページ間で設定が共有され、一貫した体験を提供
3. **拡張性**: 将来的な機能追加が容易
4. **既存機能との互換性**: 環境変数、デフォルト値の仕組みを継承

実装は段階的に進め、各Phaseで十分なテストを行うことで、リスクを最小限に抑えながら機能を追加できます。

---

**作成日**: 2026年2月9日  
**バージョン**: 1.0  
**ステータス**: 仕様検討完了
