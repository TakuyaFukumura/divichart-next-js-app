# 単年配当ポートフォリオ機能 仕様書

## 1. ドキュメント情報

- **作成日**: 2026年2月6日
- **ドキュメント種別**: 機能仕様書
- **対象機能**: 単年配当ポートフォリオ画面
- **対象読者**: 開発者、レビュアー、プロジェクト関係者

---

## 2. 機能概要

### 2.1 目的

指定した年の配当金の内訳を円グラフで表示し、ユーザーが銘柄別の配当構成を視覚的に把握できるようにする。これにより、ポートフォリオの多様化状況や特定銘柄への依存度を確認し、投資戦略の見直しに役立てることを目的とする。

### 2.2 主要機能

1. **年度別配当内訳の円グラフ表示**
    - 指定年の配当金を銘柄別に円グラフで表示
    - 配当金額の多い順にソートして表示
    - 割合の小さい銘柄は「その他」として合算表示

2. **年度切替機能**
    - 前年・次年ボタンで年度を切り替え
    - デフォルトは現在の年を表示

3. **配当内訳テーブル表示**
    - 銘柄名、配当金額、割合を一覧表示
    - ソート順は円グラフと同一

---

## 3. UI/UX仕様

### 3.1 画面構成

```
┌─────────────────────────────────────────────────────┐
│  Header (ダークモード切替含む)                        │
├─────────────────────────────────────────────────────┤
│                                                       │
│  ┌─────────────────────────────────────────────┐    │
│  │  配当ポートフォリオ（2026年）                 │    │
│  │                                               │    │
│  │  ┌─────┐  2026年  ┌─────┐                  │    │
│  │  │  <  │          │  >  │                  │    │
│  │  └─────┘          └─────┘                  │    │
│  │                                               │    │
│  │  ┌─────────────────────────────────────┐    │    │
│  │  │                                       │    │    │
│  │  │         円グラフ                      │    │    │
│  │  │     (銘柄別配当構成)                  │    │    │
│  │  │                                       │    │    │
│  │  └─────────────────────────────────────┘    │    │
│  │                                               │    │
│  │  配当内訳一覧                                 │    │
│  │  ┌─────────────────────────────────────┐    │    │
│  │  │ 銘柄名        │ 金額[円] │ 割合[%] │    │    │
│  │  ├─────────────────────────────────────┤    │    │
│  │  │ 銘柄A         │  50,000  │  35.7   │    │    │
│  │  │ 銘柄B         │  30,000  │  21.4   │    │    │
│  │  │ 銘柄C         │  20,000  │  14.3   │    │    │
│  │  │ ...           │  ...     │  ...    │    │    │
│  │  │ その他        │  10,000  │   7.1   │    │    │
│  │  └─────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────┘    │
│                                                       │
└─────────────────────────────────────────────────────┘
```

### 3.2 レイアウト詳細

#### 3.2.1 ヘッダー部分

- **タイトル**: 「配当ポートフォリオ（{年}年）」
- **年度切替ボタン**:
    - 左側: 「< 前年」ボタン
    - 中央: 現在表示中の年（例: 「2026年」）
    - 右側: 「次年 >」ボタン
- **ボタンの無効化**:
    - データが存在しない年への移動は不可
    - ボタンをグレーアウト表示

#### 3.2.2 円グラフ

- **サイズ**: レスポンシブ対応（幅100%、高さ400px）
- **カラーパレット**: 自動で色を割り当て（Rechartsのデフォルトカラー使用）
- **ラベル表示**:
    - 銘柄名と割合を表示（例: 「銘柄A 35.7%」）
    - 割合が小さい場合は外側に表示
- **ツールチップ**:
    - 銘柄名、配当金額（円）、割合（%）を表示
- **インタラクション**:
    - セグメントにマウスオーバーでハイライト
    - クリックで選択状態の切り替え（将来拡張用）

#### 3.2.3 配当内訳テーブル

- **カラム構成**:
    1. 銘柄名（左寄せ）
    2. 配当金額[円]（右寄せ、3桁区切り）
    3. 割合[%]（右寄せ、小数点1桁）
- **ソート順**: 配当金額の降順（円グラフと同一）
- **スタイル**:
    - ヘッダー行は背景色でハイライト
    - 行ごとの区切り線
    - 「その他」行は視覚的に区別（例: イタリック体）

### 3.3 レスポンシブ対応

#### モバイル（~768px）

- 円グラフの高さを300pxに縮小
- テーブルのフォントサイズを小さく調整
- 横スクロール可能にする

#### タブレット（768px~1024px）

- 円グラフとテーブルを上下に配置
- 円グラフの高さ350px

#### デスクトップ（1024px~）

- 円グラフとテーブルを並列表示可能（オプション）
- 円グラフの高さ400px

### 3.4 ダークモード対応

- 円グラフの背景色: ダークモード時はグレー系
- テキスト色: ライトモード時は黒系、ダークモード時は白系
- テーブル行の背景: 交互に色を変える（ストライプ）

---

## 4. データ構造仕様

### 4.1 CSVデータ構造（入力）

既存のCSVデータ構造を使用:

```csv
入金日,商品,口座,銘柄コード,銘柄,受取通貨,単価[円/現地通貨],数量[株/口],配当・分配金合計（税引前）[円/現地通貨],税額合計[円/現地通貨],受取金額[円/現地通貨]
2026/02/06,米国株式,旧NISA,BLV,VA L-TERM BOND,USドル,0.27745,11,3.05,0,2.74
```

**使用するカラム**:

- `入金日`: 年の抽出に使用
- `銘柄`: 銘柄名として使用
- `受取通貨`: 為替換算の判定に使用
- `受取金額[円/現地通貨]`: 配当金額（税引き後）

### 4.2 データ型定義（TypeScript）

```typescript
/**
 * 銘柄別配当データ
 */
type StockDividend = {
    /** 銘柄名 */
    stockName: string;
    /** 配当金額（税引き後）[円] */
    amount: number;
    /** 配当割合 [%] */
    percentage: number;
    /** 色コード（円グラフ用） */
    color?: string;
};

/**
 * 年度別配当ポートフォリオデータ
 */
type YearlyPortfolio = {
    /** 対象年 */
    year: number;
    /** 銘柄別配当データ（降順ソート済み） */
    stocks: StockDividend[];
    /** 年間配当金合計 [円] */
    totalAmount: number;
};

/**
 * ポートフォリオコンポーネントのプロパティ
 */
type PortfolioProps = {
    /** 表示対象年 */
    year: number;
    /** 年度変更ハンドラ */
    onYearChange: (year: number) => void;
    /** 利用可能な年のリスト */
    availableYears: number[];
};
```

### 4.3 データ集計ロジック

#### 4.3.1 銘柄別配当金の集計

```typescript
/**
 * 指定年の銘柄別配当金を集計する
 *
 * @param csvData - CSVから読み込んだ配当データ
 * @param targetYear - 集計対象年
 * @param exchangeRate - USドル→円の為替レート
 * @returns 銘柄別配当データの配列（降順ソート済み）
 */
function calculateStockDividends(
    csvData: CSVRow[],
    targetYear: number,
    exchangeRate: number
): StockDividend[] {
    // 1. 指定年のデータをフィルタリング
    // 2. 銘柄名でグループ化し、配当金を合算
    // 3. USドル建ては為替換算
    // 4. 金額の降順でソート
    // 5. 合計金額から割合を計算
    // 6. 返却
}
```

#### 4.3.2 「その他」の集約ロジック

配当金額が少ない銘柄を「その他」として集約する基準:

**基準オプション1: 閾値ベース**

- 割合が5%未満の銘柄を「その他」に集約
- または: 金額が一定額（例: 10,000円）未満を集約

**基準オプション2: 件数ベース（推奨）**

- 上位N件（例: 10件）を個別表示
- それ以外を「その他」に集約
- Nは設定可能（デフォルト: 10）

**実装方針**: オプション2を採用

- 理由: 表示件数が安定し、UI設計がしやすい
- 閾値ベースは銘柄数が不定になり表示が不安定になる可能性

```typescript
/**
 * 上位N件以外を「その他」に集約
 *
 * @param stocks - 銘柄別配当データ（ソート済み）
 * @param topN - 個別表示する銘柄数（デフォルト: 10）
 * @returns 「その他」集約後の銘柄別配当データ
 */
function aggregateOthers(
    stocks: StockDividend[],
    topN: number = 10
): StockDividend[] {
    if (stocks.length <= topN) {
        return stocks;
    }

    const totalAmount = stocks.reduce((sum, s) => sum + s.amount, 0);

    const topStocks = stocks.slice(0, topN);
    const otherStocks = stocks.slice(topN);

    const otherAmount = otherStocks.reduce((sum, s) => sum + s.amount, 0);
    const otherPercentage =
        totalAmount === 0 ? 0 : (otherAmount / totalAmount) * 100;
    return [
        ...topStocks,
        {
            stockName: 'その他',
            amount: otherAmount,
            percentage: otherPercentage,
            color: '#9ca3af', // グレー系の色
        }
    ];
}
```

---

## 5. ルーティング・ナビゲーション仕様

### 5.1 URL構造

**オプション1: クエリパラメータ方式（推奨）**

```
/portfolio?year=2026
```

- メリット: 既存のページ構造を維持、実装が容易
- デメリット: URL構造が明確でない

**オプション2: パスパラメータ方式**

```
/portfolio/2026
```

- メリット: RESTfulな設計、URL構造が明確
- デメリット: 動的ルーティングの実装が必要

**採用方針**: オプション1（クエリパラメータ方式）

- 理由: 実装が容易で、年度未指定時のデフォルト表示が自然
- 将来的にパスパラメータ方式への移行も可能

### 5.2 デフォルト動作

- URLに`year`パラメータがない場合:
    - まず「現在の年」に対する配当データの有無を確認する
    - データがある場合: 現在年のデータを表示
    - データがない場合: `availableYears` に含まれる年のうち「最も新しい年」のデータを表示（自動的に年度を切り替える）
- URLに`year`パラメータで指定された年にデータがない場合:
    - `availableYears` に含まれる年のうち「最も新しい年」のデータを表示し、画面上に「指定された年には配当データがないため、最新年（YYYY年）を表示しています」といった情報メッセージを表示する
    - `availableYears` が空（＝いずれの年にもデータが存在しない）場合は、グラフを表示せず「表示可能な配当データがありません」とメッセージを表示する

### 5.3 ナビゲーション

**ヘッダーメニューへの追加**

```
┌────────────────────────────────┐
│  DiviChart                     │
│  [配当グラフ] [ポートフォリオ] │
└────────────────────────────────┘
```

- 「配当グラフ」: 既存のホームページ（年別推移）
- 「ポートフォリオ」: 新規の配当ポートフォリオ画面

---

## 6. 実装計画

### 6.1 ファイル構成

```
src/
├── app/
│   ├── components/
│   │   ├── DarkModeProvider.tsx      # 既存
│   │   ├── Header.tsx                # 既存（メニュー追加）
│   │   ├── DividendPieChart.tsx      # 新規：円グラフコンポーネント
│   │   ├── DividendTable.tsx         # 新規：配当テーブルコンポーネント
│   │   └── YearSelector.tsx          # 新規：年度選択コンポーネント
│   ├── portfolio/
│   │   └── page.tsx                  # 新規：ポートフォリオページ
│   ├── layout.tsx                    # 既存
│   └── page.tsx                      # 既存
├── lib/
│   ├── dividendCalculator.ts        # 新規：配当計算ロジック
│   └── csvLoader.ts                 # 新規：CSV読み込みロジック（既存から抽出）
└── types/
    └── dividend.ts                  # 新規：型定義の集約
```

### 6.2 実装の優先順位

#### Phase 1: 基本機能（必須）

1. **CSV読み込みロジックの共通化**
    - 既存のpage.tsxからCSV読み込み部分を抽出
    - `src/lib/csvLoader.ts`に移動
    - 想定工数: 2時間

2. **配当計算ロジックの実装**
    - 銘柄別集計機能
    - 「その他」集約機能
    - `src/lib/dividendCalculator.ts`に実装
    - 想定工数: 3時間

3. **ポートフォリオページの作成**
    - `portfolio/page.tsx`の実装
    - データ読み込みと状態管理
    - 想定工数: 2時間

4. **円グラフコンポーネントの実装**
    - Rechartsを使用した円グラフ
    - ツールチップのカスタマイズ
    - 想定工数: 3時間

5. **配当テーブルコンポーネントの実装**
    - 銘柄別配当一覧の表示
    - ソート機能
    - 想定工数: 2時間

6. **年度選択機能の実装**
    - 前年・次年ボタン
    - 年度表示
    - 想定工数: 2時間

7. **ヘッダーメニューの拡張**
    - ナビゲーションリンクの追加
    - 想定工数: 1時間

**Phase 1 合計**: 約15時間

#### Phase 2: 機能拡張（オプション）

1. **URLパラメータ連携**
    - クエリパラメータでの年度指定
    - 想定工数: 1時間

2. **エラーハンドリングの強化**
    - データなし時の表示
    - エラー状態の管理
    - 想定工数: 2時間

3. **パフォーマンス最適化**
    - データキャッシング
    - 不要な再計算の削減
    - 想定工数: 2時間

**Phase 2 合計**: 約5時間

#### Phase 3: UI/UX改善（オプション）

1. **アニメーション追加**
    - 年度切替時のトランジション
    - 円グラフの表示アニメーション
    - 想定工数: 2時間

2. **データフィルタリング機能**
    - 銘柄種別でのフィルタリング
    - 口座種別でのフィルタリング
    - 想定工数: 3時間

3. **エクスポート機能**
    - CSV/PNG形式でのエクスポート
    - 想定工数: 3時間

**Phase 3 合計**: 約8時間

### 6.3 マイルストーン

- **Week 1**: Phase 1の実装完了
- **Week 2**: Phase 2の実装、テスト実施
- **Week 3**: Phase 3（必要に応じて）、ドキュメント整備

---

## 7. テスト計画

### 7.1 ユニットテスト

#### 7.1.1 計算ロジックのテスト

**対象**: `src/lib/dividendCalculator.ts`

テストケース:

1. **銘柄別集計の正確性**
    - 複数行の同一銘柄を正しく合算できるか
    - 円建てとUSドル建てを正しく処理できるか
    - 税引き後金額を正しく使用しているか

2. **割合計算の正確性**
    - 合計金額に対する割合が正しいか
    - 小数点の丸め処理が適切か
    - 合計が100%になるか（誤差許容）

3. **ソート機能**
    - 金額降順で正しくソートされるか
    - 同額の場合の順序は安定しているか

4. **「その他」集約機能**
    - 上位N件が正しく選択されるか
    - 「その他」の金額・割合が正しく計算されるか
    - N件以下の場合は集約しないか

5. **エッジケース**
    - データが0件の場合
    - データが1件の場合
    - 全て同一銘柄の場合
    - 金額が0円の配当がある場合

#### 7.1.2 コンポーネントのテスト

**対象**: React コンポーネント

テストケース:

1. **DividendPieChart**
    - データが正しく表示されるか
    - ツールチップが動作するか
    - ダークモードで色が適切に変わるか

2. **DividendTable**
    - テーブルが正しく表示されるか
    - 金額のフォーマットが正しいか
    - 割合の小数点表示が正しいか

3. **YearSelector**
    - 年度が正しく表示されるか
    - ボタンクリックで年度が変わるか
    - データがない年へのボタンが無効化されるか

4. **PortfolioPage**
    - ローディング状態が表示されるか
    - エラー状態が表示されるか
    - データが正しく渡されているか

### 7.2 インテグレーションテスト

#### 7.2.1 データフロー全体のテスト

テストシナリオ:

1. **正常系: CSV読み込み → 集計 → 表示**
    - CSVファイルを読み込む
    - 指定年のデータを集計する
    - 円グラフとテーブルに表示する

2. **年度切替**
    - 初期表示（デフォルト年）
    - 前年ボタンをクリック
    - 次年ボタンをクリック
    - データがない年には移動できない

3. **為替レート変更**
    - 為替レートを変更
    - 配当金額が再計算される
    - 円グラフが更新される

4. **異常系: ファイルなし**
    - CSVファイルが存在しない場合
    - エラーメッセージが表示される

5. **異常系: データなし**
    - 指定年のデータがない場合
    - 適切なメッセージが表示される

### 7.3 E2Eテスト（オプション）

Playwrightを使用したE2Eテスト:

1. **ページ遷移**
    - トップページからポートフォリオページへ遷移
    - URLが正しく変わるか

2. **ユーザーインタラクション**
    - 年度切替ボタンの操作
    - 円グラフのホバー
    - ダークモード切替

3. **レスポンシブ対応**
    - モバイル表示の確認
    - タブレット表示の確認

### 7.4 テストカバレッジ目標

- **ライン カバレッジ**: 80%以上
- **ブランチ カバレッジ**: 75%以上
- **関数 カバレッジ**: 85%以上

---

## 8. パフォーマンス要件

### 8.1 レスポンス時間

- **初期ロード**: 2秒以内
- **年度切替**: 500ms以内
- **為替レート変更**: 500ms以内

### 8.2 最適化手法

1. **データキャッシング**
    - CSVデータを初回のみ読み込み
    - 集計結果をメモ化

2. **レンダリング最適化**
    - `React.memo`でコンポーネントのメモ化
    - `useMemo`で計算結果のメモ化
    - `useCallback`でイベントハンドラのメモ化

3. **遅延ロード**
    - Rechartsの動的インポート
    - ページネーション（銘柄数が多い場合）

---

## 9. ドキュメント・メンテナンス

### 9.1 ドキュメント更新

実装完了後に以下を更新:

1. **README.md**
    - 新機能の説明を追加
    - スクリーンショットを追加

2. **developer-specification.md**
    - アーキテクチャ図の更新
    - 機能一覧の更新

3. **.github/copilot-instructions.md**
    - 新規コンポーネントの説明を追加
    - 開発ガイドラインの更新

### 9.2 コードコメント

- JSDocコメントを全関数に記述
- 複雑なロジックには説明コメントを追加
- 型定義に説明を記述

---

## 10. 参考資料

### 10.1 関連ドキュメント

- [developer-specification.md](./developer-specification.md): 既存アプリケーションの仕様
- [improvements.md](./improvements.md): 改善提案リスト
- [README.md](../README.md): プロジェクト概要

### 10.2 技術参考

- [Recharts Documentation](https://recharts.org/): グラフライブラリ
- [Next.js App Router](https://nextjs.org/docs/app): ルーティング
- [Tailwind CSS](https://tailwindcss.com/): スタイリング

---

## 11. 変更履歴

| 日付         | バージョン | 変更内容 | 作成者            |
|------------|-------|------|----------------|
| 2026/02/06 | 1.0.0 | 初版作成 | GitHub Copilot |

---

## 12. 承認

| 役割    | 氏名 | 承認日        | 署名 |
|-------|----|------------|----|
| 作成者   | -  | 2026/02/06 | -  |
| レビュアー | -  | -          | -  |
| 承認者   | -  | -          | -  |

---

**このドキュメントに関する質問や提案は、GitHubのIssueまたはPull Requestで受け付けています。**
